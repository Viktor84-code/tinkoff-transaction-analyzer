"""–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–π —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ –¢–∏–Ω—å–∫–æ—Ñ—Ñ"""

import sys
import os

sys.path.append('src')

import utils
import pandas as pd


def test_read_transactions():
    """–¢–µ—Å—Ç —Ñ—É–Ω–∫—Ü–∏–∏ —á—Ç–µ–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π"""
    print("üß™ –¢–ï–°–¢: read_transactions")
    print("=" * 50)

    try:
        df = utils.read_transactions('data/operations.xlsx')
        print(f"‚úÖ –£—Å–ø–µ—à–Ω–æ! –ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(df)} —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π")

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–æ–ª–±—Ü—ã
        required_cols = [
            '–î–∞—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏',
            '–°—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞',
            '–ö–∞—Ç–µ–≥–æ—Ä–∏—è',
            '–ö—ç—à–±—ç–∫',  # –û–±—Ä–∞—Ç–∏ –≤–Ω–∏–º–∞–Ω–∏–µ: '—ç' –∞ –Ω–µ '–µ'
            '–û–ø–∏—Å–∞–Ω–∏–µ'
        ]

        print("\nüìã –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–ª–±—Ü–æ–≤:")
        for col in required_cols:
            if col in df.columns:
                print(f"  ‚úì '{col}' –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç")
            else:
                print(f"  ‚úó '{col}' –û–¢–°–£–¢–°–¢–í–£–ï–¢!")
                # –ü–æ–∫–∞–∂–µ–º –∫–∞–∫–∏–µ —Å—Ç–æ–ª–±—Ü—ã –µ—Å—Ç—å –Ω–∞ —Å–∞–º–æ–º –¥–µ–ª–µ
                print(f"     –î–æ—Å—Ç—É–ø–Ω—ã–µ —Å—Ç–æ–ª–±—Ü—ã: {[c for c in df.columns if '–∫–µ—à–±' in c.lower()]}")

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö
        print(f"\nüìä –¢–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö:")
        print(f"  –î–∞—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏: {df['–î–∞—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏'].dtype}")
        print(f"  –°—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞: {df['–°—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞'].dtype}")

        # –ü—Ä–∏–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö
        print(f"\nüëÄ –ü—Ä–∏–º–µ—Ä —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (–ø–µ—Ä–≤–∞—è):")
        print(df.iloc[0][['–î–∞—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏', '–°—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞', '–ö–∞—Ç–µ–≥–æ—Ä–∏—è', '–û–ø–∏—Å–∞–Ω–∏–µ']])

        return df

    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞: {e}")
        import traceback
        traceback.print_exc()
        return None


def test_get_top_transactions(df):
    """–¢–µ—Å—Ç —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–ø —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π"""
    print("\n\nüß™ –¢–ï–°–¢: get_top_transactions")
    print("=" * 50)

    if df is None or df.empty:
        print("‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è")
        return

    try:
        # –¢–µ—Å—Ç 1: —Ç–æ–ø 5 —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
        top5 = utils.get_top_transactions(df, n=5)
        print(f"‚úÖ –¢–æ–ø-5 —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –ø–æ–ª—É—á–µ–Ω–æ: {len(top5)}")

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
        if top5:
            print(f"\nüìã –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞:")
            print(f"  –¢–∏–ø: {type(top5)}")
            print(f"  –≠–ª–µ–º–µ–Ω—Ç—ã: {type(top5[0])}")
            print(f"  –ö–ª—é—á–∏ –≤ —ç–ª–µ–º–µ–Ω—Ç–µ: {list(top5[0].keys())[:5]}...")

            # –ü–æ–∫–∞–∂–µ–º —Å–∞–º—É—é –∫—Ä—É–ø–Ω—É—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
            print(f"\nüíé –°–∞–º–∞—è –∫—Ä—É–ø–Ω–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è:")
            largest = top5[0]
            print(f"  –°—É–º–º–∞: {largest.get('–°—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞', '–ù–µ—Ç –∫–ª—é—á–∞')}")
            print(f"  –ö–∞—Ç–µ–≥–æ—Ä–∏—è: {largest.get('–ö–∞—Ç–µ–≥–æ—Ä–∏—è', '–ù–µ—Ç –∫–ª—é—á–∞')}")
            print(f"  –û–ø–∏—Å–∞–Ω–∏–µ: {largest.get('–û–ø–∏—Å–∞–Ω–∏–µ', '–ù–µ—Ç –∫–ª—é—á–∞')}")

        # –¢–µ—Å—Ç 2: —Å –º–µ–Ω—å—à–∏–º n
        top2 = utils.get_top_transactions(df, n=2)
        print(f"\n‚úÖ –¢–æ–ø-2 —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π: {len(top2)}")

        # –¢–µ—Å—Ç 3: —Å –ø—É—Å—Ç—ã–º DataFrame
        empty_df = pd.DataFrame()
        empty_result = utils.get_top_transactions(empty_df, n=5)
        print(f"\n‚úÖ –ü—É—Å—Ç–æ–π DataFrame: –≤–µ—Ä–Ω—É–ª–æ {len(empty_result)} —ç–ª–µ–º–µ–Ω—Ç–æ–≤")

    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞: {e}")
        import traceback
        traceback.print_exc()


def test_filter_by_date(df):
    """–¢–µ—Å—Ç —Ñ—É–Ω–∫—Ü–∏–∏ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ –¥–∞—Ç–µ"""
    print("\n\nüß™ –¢–ï–°–¢: filter_by_date")
    print("=" * 50)

    if df is None or df.empty:
        print("‚ùå –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è")
        return

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ —Ñ—É–Ω–∫—Ü–∏—è
    if not hasattr(utils, 'filter_by_date'):
        print("‚ùå –§—É–Ω–∫—Ü–∏—è filter_by_date –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ utils.py")
        print("   –ù—É–∂–Ω–æ –µ—ë —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å!")
        return

    try:
        # –¢–µ—Å—Ç: —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∑–∞ –¥–µ–∫–∞–±—Ä—å 2021
        print("üìÖ –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∑–∞ –¥–µ–∫–∞–±—Ä—å 2021:")
        filtered = utils.filter_by_date(df, '2021-12-01', '2021-12-31')

        if filtered is not None:
            print(f"‚úÖ –£—Å–ø–µ—à–Ω–æ! –û—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–æ: {len(filtered)} —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π")
            print(f"   –ò—Å—Ö–æ–¥–Ω–æ: {len(df)} —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π")

            if len(filtered) > 0:
                print(f"\nüëÄ –ü–µ—Ä–≤–∞—è –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω–∞—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è:")
                print(filtered.iloc[0][['–î–∞—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏', '–°—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞', '–ö–∞—Ç–µ–≥–æ—Ä–∏—è']])
        else:
            print("‚ö†Ô∏è –§—É–Ω–∫—Ü–∏—è –≤–µ—Ä–Ω—É–ª–∞ None")

    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–∑–æ–≤–µ —Ñ—É–Ω–∫—Ü–∏–∏: {e}")
        print("\nüí° –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:")
        print("   1. –§—É–Ω–∫—Ü–∏—è –Ω–µ –¥–æ –∫–æ–Ω—Ü–∞ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞")
        print("   2. –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã")
        print("   3. –ü—Ä–æ–±–ª–µ–º—ã —Å —Ñ–æ—Ä–º–∞—Ç–æ–º –¥–∞—Ç")
        import traceback
        traceback.print_exc()


def check_all_functions():
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π"""
    print("\n\nüîç –ü–†–û–í–ï–†–ö–ê –í–°–ï–• –§–£–ù–ö–¶–ò–ô –í utils.py")
    print("=" * 50)

    required_functions = [
        'read_transactions',
        'get_top_transactions',
        'filter_by_date',
        'calculate_total_spent',
        'calculate_cashback',
        'get_transactions_by_card',
        'format_currency'
    ]

    for func_name in required_functions:
        if hasattr(utils, func_name):
            print(f"  ‚úì {func_name}")
        else:
            print(f"  ‚úó {func_name} - –û–¢–°–£–¢–°–¢–í–£–ï–¢!")


def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è"""
    print("üöÄ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –§–£–ù–ö–¶–ò–ô –° –†–ï–ê–õ–¨–ù–´–ú–ò –î–ê–ù–ù–´–ú–ò –¢–ò–ù–¨–ö–û–§–§")
    print("=" * 60)

    # –¢–µ—Å—Ç 1: –ß—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
    df = test_read_transactions()

    # –¢–µ—Å—Ç 2: –¢–æ–ø —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
    if df is not None:
        test_get_top_transactions(df)

        # –¢–µ—Å—Ç 3: –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ –¥–∞—Ç–µ
        test_filter_by_date(df)

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö —Ñ—É–Ω–∫—Ü–∏–π
    check_all_functions()

    print("\n" + "=" * 60)
    print("‚úÖ –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û")


if __name__ == "__main__":
    main()
