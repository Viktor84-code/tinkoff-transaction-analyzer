"""
–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π.
–°–æ–∑–¥–∞—ë—Ç —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π Excel-—Ñ–∞–π–ª —Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏ –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞.
"""

import pandas as pd
from datetime import datetime, timedelta
import random
import os


def generate_transactions(num_records: int = 250) -> pd.DataFrame:
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Ç–µ—Å—Ç–æ–≤—ã–µ –±–∞–Ω–∫–æ–≤—Å–∫–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.

    Args:
        num_records: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏

    Returns:
        DataFrame —Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏
    """
    print(f"üéØ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è {num_records} —Ç–µ—Å—Ç–æ–≤—ã—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π...")

    # –†–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    categories = [
        '–°—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç—ã', '–ö–∞—Ñ–µ –∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã', '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç',
        '–ó–¥–æ—Ä–æ–≤—å–µ', '–†–∞–∑–≤–ª–µ—á–µ–Ω–∏—è', '–û–¥–µ–∂–¥–∞ –∏ –æ–±—É–≤—å',
        '–ñ–ö–•', '–ü–µ—Ä–µ–≤–æ–¥—ã', '–ù–∞–ª–∏—á–Ω—ã–µ', '–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è'
    ]

    descriptions_map = {
        '–°—É–ø–µ—Ä–º–∞—Ä–∫–µ—Ç—ã': ['–ü—è—Ç–µ—Ä–æ—á–∫–∞', '–ú–∞–≥–Ω–∏—Ç', '–õ–µ–Ω—Ç–∞', '–ê—à–∞–Ω', '–ü–µ—Ä–µ–∫—Ä—ë—Å—Ç–æ–∫'],
        '–ö–∞—Ñ–µ –∏ —Ä–µ—Å—Ç–æ—Ä–∞–Ω—ã': ['Starbucks', 'KFC', 'Burger King', '–ö–æ—Ñ–µ–º–∞–Ω–∏—è', '–ú–∞–∫–¥–æ–Ω–∞–ª–¥—Å'],
        '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç': ['–Ø–Ω–¥–µ–∫—Å.–¢–∞–∫—Å–∏', '–°–∏—Ç–∏–º–æ–±–∏–ª', '–ú–µ—Ç—Ä–æ', '–ê–ó–° –õ—É–∫–æ–π–ª', 'Shell'],
        '–ü–µ—Ä–µ–≤–æ–¥—ã': ['–ü–µ—Ä–µ–≤–æ–¥ –¥—Ä—É–≥—É', '–ü–µ—Ä–µ–≤–æ–¥ –º–µ–∂–¥—É —Å—á–µ—Ç–∞–º–∏', '–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∞'],
        '–ù–∞–ª–∏—á–Ω—ã–µ': ['–°–Ω—è—Ç–∏–µ –≤ –±–∞–Ω–∫–æ–º–∞—Ç–µ –¢–∏–Ω—å–∫–æ—Ñ—Ñ', '–ë–∞–Ω–∫–æ–º–∞—Ç –°–±–µ—Ä–±–∞–Ω–∫–∞']
    }

    cards = ['5814', '7512', '9632', '1248']
    statuses = ['OK', 'FAILED', 'PENDING']

    transactions = []
    start_date = datetime(2023, 1, 1)

    for i in range(num_records):
        # –°–ª—É—á–∞–π–Ω–∞—è –¥–∞—Ç–∞ –≤ 2023-2024
        days_offset = random.randint(0, 730)  # 2 –≥–æ–¥–∞
        operation_date = start_date + timedelta(days=days_offset)

        # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏: 75% —Ä–∞—Å—Ö–æ–¥—ã, 25% –¥–æ—Ö–æ–¥—ã
        is_expense = random.random() < 0.75

        if is_expense:
            amount = -round(random.uniform(100, 25000), 2)  # –†–∞—Å—Ö–æ–¥
            cashback = round(abs(amount) * random.uniform(0.005, 0.02), 2)  # 0.5-2%
        else:
            amount = round(random.uniform(5000, 100000), 2)  # –î–æ—Ö–æ–¥
            cashback = 0.0

        category = random.choice(categories)

        # –í—ã–±–∏—Ä–∞–µ–º –æ–ø–∏—Å–∞–Ω–∏–µ
        if category in descriptions_map:
            description = random.choice(descriptions_map[category])
        else:
            description = f"–ü–æ–∫—É–ø–∫–∞: {category}"

        # –°–æ–∑–¥–∞—ë–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
        transaction = {
            '–î–∞—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏': operation_date.strftime('%Y-%m-%d'),
            '–î–∞—Ç–∞ –ø–ª–∞—Ç–µ–∂–∞': (operation_date + timedelta(days=random.randint(0, 5))).strftime('%Y-%m-%d'),
            '–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã': random.choice(cards),
            '–°—Ç–∞—Ç—É—Å': random.choice(statuses),
            '–°—É–º–º–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏': amount,
            '–í–∞–ª—é—Ç–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏': 'RUB',
            '–°—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞': abs(amount) if amount < 0 else amount,
            '–í–∞–ª—é—Ç–∞ –ø–ª–∞—Ç–µ–∂–∞': 'RUB',
            '–ö–µ—à–±—ç–∫': cashback,
            '–ö–∞—Ç–µ–≥–æ—Ä–∏—è': category,
            'MCC': random.randint(1000, 9999),
            '–û–ø–∏—Å–∞–Ω–∏–µ': f"{description} #{random.randint(100, 999)}",
            '–ë–æ–Ω—É—Å—ã (–≤–∫–ª—é—á–∞—è –∫–µ—à–±—ç–∫)': round(cashback * 1.5, 2),
            '–û–∫—Ä—É–≥–ª–µ–Ω–∏–µ –Ω–∞ –ò–Ω–≤–µ—Å—Ç–∫–æ–ø–∏–ª–∫—É': random.choice([0, 5, 10, 50, 100]),
            '–°—É–º–º–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –æ–∫—Ä—É–≥–ª–µ–Ω–∏–µ–º': round(amount, -1) if amount < 0 else amount
        }
        transactions.append(transaction)

    # –°–æ–∑–¥–∞—ë–º DataFrame
    df = pd.DataFrame(transactions)
    return df


def save_transactions_to_excel(df: pd.DataFrame, filename: str = 'operations.xlsx'):
    """
    –°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤ Excel —Ñ–∞–π–ª.

    Args:
        df: DataFrame —Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏
        filename: –∏–º—è —Ñ–∞–π–ª–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
    """
    # –°–æ–∑–¥–∞—ë–º –ø–∞–ø–∫—É –µ—Å–ª–∏ –Ω–µ—Ç
    os.makedirs('data', exist_ok=True)

    filepath = os.path.join('data', filename)
    df.to_excel(filepath, index=False)

    print(f"‚úÖ –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤: {filepath}")
    print(f"üìä –†–∞–∑–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö: {len(df)} —Å—Ç—Ä–æ–∫ √ó {len(df.columns)} –∫–æ–ª–æ–Ω–æ–∫")

    return filepath


def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞."""
    print("=" * 50)
    print("–ì–ï–ù–ï–†–ê–¢–û–† –¢–ï–°–¢–û–í–´–• –î–ê–ù–ù–´–• –î–õ–Ø –ê–ù–ê–õ–ò–ó–ê–¢–û–†–ê –¢–†–ê–ù–ó–ê–ö–¶–ò–ô")
    print("=" * 50)

    try:
        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ
        df = generate_transactions(300)  # 300 —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º
        saved_path = save_transactions_to_excel(df, 'operations.xlsx')

        # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
        print("\nüìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:")
        print(f"   ‚Ä¢ –†–∞—Å—Ö–æ–¥—ã: {len(df[df['–°—É–º–º–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏'] < 0])} —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π")
        print(f"   ‚Ä¢ –î–æ—Ö–æ–¥—ã: {len(df[df['–°—É–º–º–∞ –æ–ø–µ—Ä–∞—Ü–∏–∏'] > 0])} —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π")
        print(f"   ‚Ä¢ –ö–∞—Ä—Ç—ã: {df['–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã'].unique()}")
        print(f"   ‚Ä¢ –ö–∞—Ç–µ–≥–æ—Ä–∏–∏: {len(df['–ö–∞—Ç–µ–≥–æ—Ä–∏—è'].unique())} —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö")

        print("\nüéâ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!")
        print("–§–∞–π–ª –≥–æ—Ç–æ–≤ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –ø—Ä–æ–µ–∫—Ç–µ.")

    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö: {e}")
        raise


if __name__ == "__main__":
    main()
